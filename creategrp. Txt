<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Group with Permissions</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<h2>Create Group with Permissions</h2>

<!-- Group Name -->
<label for="groupName">Group Name:</label>
<input type="text" id="groupName" placeholder="Enter Group Name" />

<!-- Permission Level Dropdown -->
<label for="permissionLevel">Select Permission Level:</label>
<select id="permissionLevel">
    <option value="1073741829">Full Control</option>
    <option value="1073741830">Edit</option>
    <option value="1073741827">Contribute</option>
    <option value="1073741826">Read</option>
    <option value="1073741825">View Only</option>
</select>

<!-- Create Button -->
<button onclick="createGroup()">Create Group</button>

<script>
    // Step 1: Load Permission Levels from SharePoint
    function loadPermissionLevels() {
        $.ajax({
            url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/roledefinitions",
            type: "GET",
            headers: {
                "Accept": "application/json;odata=verbose"
            },
            success: function (data) {
                const permissionLevels = data.d.results;
                let options = '';
                permissionLevels.forEach(function (level) {
                    options += `<option value="${level.Id}">${level.RoleTypeKind} - ${level.Name}</option>`;
                });
                $('#permissionLevel').html(options);
            },
            error: function (xhr, status, error) {
                console.log("Error loading permission levels", error);
            }
        });
    }

    // Step 2: Create Group and Assign Permission
    function createGroup() {
        const groupName = $('#groupName').val().trim();
        const selectedPermissionId = $('#permissionLevel').val();

        if (!groupName || !selectedPermissionId) {
            alert("Please provide group name and select permission level.");
            return;
        }

        // Step 2.1: Create Group
        $.ajax({
            url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/sitegroups",
            type: "POST",
            data: JSON.stringify({
                '__metadata': { 'type': 'SP.Group' },
                'Title': groupName,
                'Description': 'Group created using REST API'
            }),
            headers: {
                "Accept": "application/json;odata=verbose",
                "Content-Type": "application/json;odata=verbose",
                "X-RequestDigest": $("#__REQUESTDIGEST").val()
            },
            success: function (groupData) {
                alert("Group created successfully!");

                // Step 2.2: Assign Permission Level to the Group
                const groupId = groupData.d.Id;
                assignPermissionToGroup(groupId, selectedPermissionId);
            },
            error: function (xhr, status, error) {
                alert("Failed to create group");
                console.log("Error", error);
            }
        });
    }

    // Step 3: Assign Permission Level to the Created Group
    function assignPermissionToGroup(groupId, permissionId) {
        $.ajax({
            url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/roleassignments/addroleassignment(principalid=" + groupId + ", roledefid=" + permissionId + ")",
            type: "POST",
            headers: {
                "Accept": "application/json;odata=verbose",
                "Content-Type": "application/json;odata=verbose",
                "X-RequestDigest": $("#__REQUESTDIGEST").val()
            },
            success: function () {
                alert("Permission level assigned successfully!");
            },
            error: function (xhr, status, error) {
                alert("Failed to assign permission level.");
                console.log("Error", error);
            }
        });
    }

    // Call this function to load permission levels on page load
    $(document).ready(function () {
        loadPermissionLevels();
    });
</script>

</body>
</html>
